---
title: "Astro製ブログをGitHub Pagesのサブディレクトリに公開する"
description: "爆速Webサイトを作成可能なAstroでブログを作ったら、サブディレクト関係で落とし穴が多くて色々と工夫が必要だったのでメモしておく。"
pubDate: "2023-02-20"
heroImage: "/placeholder-hero.jpg"
tags: ["プログラム", "Astro"]
---
import Image from '../../components/Image.astro';

Astroは、主にSSG (Static Site Generator) として動作し、爆速の静的サイトを生成するライブラリ。

基本的に使いやすいのだけれど、タイトルのような条件でブログを作ろうとしたら微妙に大変だったので、やり方をメモしておく。

ちなみに一応これでちゃんと動くけど、**書いているやり方が正しいのかどうかはよく分からず、全然自信がない**。あくまでも自分で編み出した方法なので、もしもっと良いやり方があれば教えて欲しい。

# 結論

- 自サイト内へのリンクや画像等の参照では、**リポジトリ名を付与した絶対パスで行えばOK**。
- リポジトリ名の記載がコードのあちこちに分散していると面倒なので、まとめると楽。
  - そのとき、環境変数（的なもの）を使えばもっと楽。（でもちょっと罠がある）
  - ブログの記事（`.md`ファイル）からの画像の読み込みを楽にするならさらに色々と工夫が必要。

# 前段の話・条件

タイトル通り、**Astroで構築したブログをGitHub Pagesのサブディレクトリに公開する**ものとする。

この記事を読んでいるような人には説明不要だろうけど、GitHub Pagesを使えば静的サイトを無料で手軽に公開できる。設定して、コンテンツをリポジトリにプッシュするだけでOK。他のサービス（VercelとかNetlifyとか）を使うのもアリだけど、GitHubだけで完結しているとちょっと楽な気がする。

さて、GitHub Pagesでは、リポジトリ名でサブディレクトリができる形になって、URLは `https://<ユーザ名>.github.io/<リポジトリ名>/` になる。この**サブディレクトリ**というのが曲者で、Astroで対応するためには色々と工夫が必要になる。

逆に言えば、GitHub Pagesを使ったとしても、URLがサブディレクトリを持たない以下の2パターンのいずれかのときは、この記事で書いているような工夫は不要。

- **独自ドメイン**で運用する。
- **リポジトリ名をユーザ名と同じ**にする。（これならGitHub Pagesの仕様により `https://<ユーザ名>.github.io/` となってサブディレクトリ構造にならないため）

したがって、**GitHub Pagesのドメインのまま、好きなリポジトリ名を付けて公開**するときが対象になる。

# テンプレートからブログを作成する

ここから実際にブログを作成・修正しつつ手順を説明していくけど、その前提として、マシンへそれなりに新しい Node.js がインストールされている必要がある。詳しいことは[Astro公式ドキュメントのインストールの項](https://docs.astro.build/ja/install/auto/)に書いてあるので、そっちを読むのが確実。

Astroのテンプレートを使ってブログを作成するところから始めるために、適当なディレクトリで以下のコマンドを実行する。

```
npm create astro@latest
```

色々質問されるので、それに答えていく。今回は以下のようにした。

- プロジェクトの作成先と名前：**`./astro-blog-test`**
- 使用するテンプレート：**blogテンプレート**
- 依存するものをインストールするか：**Yes**
- Gitリポジトリを初期化するか：**Yes**
- TypeScriptを使うか：**Yes**
- TypeScriptの厳しさは：**Strict**

基本的には好きなものやデフォルト項目を選べばいいけど、記事の内容をなぞるときは**テンプレートとしてブログを選ぶ**と分かりやすい。

これでひとまず動く状態となったので、当該ディレクトリに移動して以下のコマンドを実行する。

```
npm run dev
```

多分、`http://localhost:3000/`になっているので、Webブラウザでアクセスすれば、ひとまずローカル環境で動いていることが確認できる。

# GitHub Pagesへのデプロイ設定

この時点できちんと動か**ない**ことを確認するため、早速GitHub Pagesへのデプロイを行う。

この記事では、GitHubへのプッシュで自動的にサイトがビルドされるよう、GitHub Actionsによる自動デプロイを設定していく。

まずは適当にGitHubにパブリックリポジトリを作成し、それをプロジェクトのリモートリポジトリとして登録する。（この記事では`astro-test`としてみた）

それから自動デプロイのために色々と設定していく。やり方は基本的に、[Astro公式ドキュメントに書いてある通り](https://docs.astro.build/ja/guides/deploy/github/)。2023年2月時点では未翻訳で英語ではあるけど、DeepLでも使えばさっくりと読める。

やることをざっくり列挙すると以下の通り。`<ユーザ名>`と`<リポジトリ名>`は適宜自分のGitHub環境に合わせる。

1. `astro.config.mjs`に、`site`と`base`を設定する。
   - `site` は **`https://<ユーザ名>.github.io/`**
   - `base` は **`/<リポジトリ名>`**（頭にスラッシュを入れ、末尾には入れない）
2. プロジェクトのディレクトリ内に、`.github/workflows/deploy.yml`を作成し、公式ドキュメントに記載されているコードを貼り付ける。
3. GitHubのリポジトリで、**Setting** タブの **Pages** セクションを開く。
4. **Source** で **GitHub Actions** を選ぶ。
5. ローカルのリポジトリを**コミット**して**プッシュ**する。

これで自動的にデプロイされ、大体1分くらい経てばGitHub Pagesに公開されるので、`https://<ユーザ名>.github.io/<リポジトリ名>`で開けるはず。もしダメならリポジトリのActionsタブを見てビルドの実行結果がエラーになっていないかを確認して対応する。

# この時点での状況を確認

## ローカル環境

ここまでやって、ローカルで開発サーバを開いていたら（`npm run dev`が実行中のままだったら）、ページ`http://localhost:3000/`の表示が「404: Not found」エラーになっているはず。

これは先程行った`base`の設定が効いていて、ページ構造が全部`base`で設定したディレクトリ内に存在することになっているため。

したがってページを表示するには、`http://localhost:3000/`に`base`で設定したフォルダ名を書き加える。404の画面にご丁寧にフォルダへのリンクが書いてあるので、それをクリックしてもよい。

## GitHub Pages

デプロイした結果として、`https://<ユーザ名>.github.io/<リポジトリ名>`でページは開けているはず。

ただ、ブラウザの開発ツールでコンソールを見ると、ファビコン（`favicon.svg`）が404エラーとなって読み込めていないことが確認できる。

# リンクの動作を見る

さてさて、ひとまずトップページは表示されたものの、ここからが問題。ローカルでもGitHub Pagesでも、自サイト内へのリンク（例えば上部の「About」）をクリックすると、**404エラーになってアクセスでき**ないことがわかる。

これはアドレスバーを見ると分かる通り、**リンク先が正しくない**ため。サブディレクトリ内にページが存在しているはずなのに、リンクで移行するのはサブディレクトリではないページになっている。

Astroのソースコードを見れば分かりやすい。ヘッダ部分のコードは`src/components/Header.astro`であり、この13行目を見ると、Aboutのリンク先が`/about`と指定されている。つまりルートからのリンクになっているので、`<ドメイン>/about/index.html`を読み込むことになっていて、サブディレクトリが反映されておらず、存在しないページを表示しようとしているので404エラーとなっている。

そう、Astroはリンクに対して`base`の設定を反映してくれない。これは`a`タグのリンクだけでなく、ファビコンへのリンクも同様。

（ちなみにローカル側ではファビコンを読み込めているが、これは開発サーバで`301 Moved Permanently`によりリダイレクトしているため。GitHub Pagesでは動作しないため表示できないというのが、上で書いたもの）

以降、これを修正していく。

---

# 基本的な対応方針

前述の通り、リンクや画像の読み込みが上手く動かないのは、Astroが解釈するパスが実態と異なっているため。`astro.config.mjs`の`base`の設定は、反映されるところと反映されないところがある。ページ内へのリンクは、自分で対応する必要がある。

対応自体は結構単純で、**ルート「/」から始まっているパスに対して、ディレクトリ名（＝リポジトリ名）を追記する**こと。要するに、以下のように記載する。

- トップページへのリンク: `/` → **`/<リポジトリ名>/`**
- blogディレクトリへのリンク: `/blog` → **`/<リポジトリ名>/blog`**
- ファビコン（デフォルトではpublicディレクトリ直下に配置されている）の参照: `/favicon.svg` → **`/<リポジトリ名>/favicon.svg`**

ただ、直接記載するのは色々とよろしくない。例えば将来的にリポジトリ名を変更する場合、あちこちを修正することになってしまう。ということで、実際には後述するようにちょっと工夫を加えた形で対応する。

# もう1つ考えられる対応方針（この記事ではやらない方法）

もう1つ、シンプルな対応方針がある。それは**リンクを相対パスで指定すること**。例えばトップページからblogページへのリンクは、**`./blog`**と書けば良い。

ただこれ、実際にやると色々と面倒。

- ディレクトリ構造を考慮して、各ページのリンクを記述する必要がある。
  - Astroで最終的に生成されるディレクトリ構造は、生成元のディレクトリ構造と異なるため、その考慮が必要。
- ヘッダからのリンクを書くのがとても面倒。
  - （これくらいなら、記述が一箇所にまとまるので、直接書いても良い気がするけど）
- 記事からの画像読み込みに対応できない。
  - `.md`で書く記事の中から、相対パスによる画像指定は不可。

ということで逆に面倒なので、この記事ではこの対応方法は採用しない。

---

# 対応の実施

ここから実際に対応していく。

まずはDRY原則に従い、リンクで使うパスを変換する関数を作ることにする。各ページのリンクは、この関数を使用して上手いこと変換したものを使用する。

関数でやりたいことは単純で、例えば`/blog`が渡されたら`/<リポジトリ名>/blog`を返すだけ。

## パス変換関数の作成

`src/scripts/util.ts`を作成して、以下のようなコードを書く。中身はまぁ単純。

```ts
export function href(s: string): string {
  if (s.charAt(0) === '/') {
    s = s.substring(1);
  }
  return `${import.meta.env.BASE_URL}${s}`;
}
```

`import.meta.env.BASE_URL`は`base`で設定している値を取得できる、環境変数的なもの。これを用いて`base`の値を利用しているため、リポジトリ名が変わった場合でも設定ファイルの変更だけで済み、ソースコードの変更が不要になる。

ただこれ、チェックが明らかに不十分なので注意。例えば相対パスが渡されたり、 `https://` から始まるURLが渡されたときに不正な値を返す。実際に使うときはそのあたりをきちんとチェックすべき。

## `import.meta.env.BASE_URL`の罠

Astro の環境変数的な`import.meta.env.BASE_URL`の値を利用しているが、これに罠がある。

ただこれ、[ドキュメントに記載されている使い方が](https://docs.astro.build/en/reference/configuration-reference/#base)、**書かれている内容が嘘**。

ドキュメントには```<img src=`${import.meta.env.BASE_URL}/image.png`>```と書かれているけど、この変数はなぜか**末尾にスラッシュが付いた形**で返ってくる。すなわち、ドキュメント通りに書くと、スラッシュが2つ連続した文字列になってしまう。なので、上記のコードでは、引数で渡された1文字目のスラッシュを`if`内で削除するとともに、文字列の連結時に間にスラッシュを入れないようにしてにいる。



## 関数の使い方

この関数を使ってリンクを行うときは、当該ページで`href()`をインポートして、リンクが書かれている部分で`href()`を使うように修正する。

具体的には以下のようになる。

```ts
// src/components/Header.astro
---
// (フロントマター内)
import { href } from '../scripts/util';
---
...
- <HeaderLink href="/">Home</HeaderLink>
+ <HeaderLink href={href("/")}>Home</HeaderLink>
<HeaderLink href="/blog">Blog</HeaderLink>
<HeaderLink href="/about">About</HeaderLink>
...
```

他にも以下のような部分を同様に修正すれば良い。

- `src/components/BaseHead.astro`のファビコンの読み込み部分(20行目)
- `src/lauouts/BlotPost.astro`の`heroImage`の読み込み部分(35行目)
  - `src={heroImage}`→`src={href(heroImage)}`
  -

# 記事のMarkdownファイルで読み込む画像に対応する

上記の修正を行うと、記事へのリンクは解決できるものの、ブログ記事からの画像読み込みがダメだと気づく。

上記の修正は`.astro`ファイルのようにJavaScriptのコードを書ける部分では対応できるが、記事になる`.md`ファイルの中で読み込む画像には対応していない。もちろんリポジトリ名を直接書けばいいのだけど、それは面倒くさい。

ということで、**MDXファイル**とコンポーネントを使って解決する。パスを上手いこと変換してくれるコンポーネントを作って、
この方法はもちろんサイト内へのリンクについても同様の方法を使って解決できる。

## コンポーネントの作成

`/src/components/Image.astro`を作成する。中身は以下の通り。

```astro
```

単純に、引数で渡されたパスを`href()`で変換して、`img`要素に設定しているだけの単純なコンポーネント。一応、プロパティに型を付けている。

## 記事ファイルをMDXにする

この機能を使う記事ファイルの拡張子を`.md`から`.mdx`にする。

（エディタで`.mdx`もMarkdownとして扱うようにすれば、編集が楽になる）


# 補足

ここまで色々やってきたけど、他の解決策を思いつくかもしれない。

例えば、画像読み込みで、相対パスを指定すればいいのでは、とか。ただこれを実際にやってみるとわかるけど、エラーが出て表示できない。
`content/`ディレクトリから`public/`ディレクトリへの相対パス指定はできないから絶対パスで指定してくれ、という。

